<body style="-webkit-app-region: drag; margin: 0;">

    <video id="video" width="100%" height="100%" controls></video>

    <script>
        const {BrowserWindow} = require('electron').remote;
        const ipc = require('electron').ipcRenderer;
        const Hls = require('hls.js');
        const video = document.getElementById('video');

        // get video url from renderer
        ipc.on('video', function(event, video_url, renderer_window_id) {

            // play mp4
            if (video_url.includes(".mp4")) {
                play_mp4();
                return;
            }

            // play m3u
            const hls = new Hls({fragLoadingMaxRetry: 1});
            hls.loadSource(video_url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
            });

            hls.on(Hls.Events.ERROR, function(event, data) {
                console.log(data);
                if (data.fatal)
                    report_video_outdated();
            });


            async function play_mp4() {
                video.src = video_url;
                try {
                    await video.play();
                }
                catch (err) {
                    report_video_outdated();
                }
            }

            // request updated video url from renderer 
            function report_video_outdated() {
                console.log(video_url);
                console.log('video outdated');
                video.pause();
                BrowserWindow.fromId(renderer_window_id).webContents.send('video_outdated');
            }
        });
    </script>

</body>
